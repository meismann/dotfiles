# git push squashed
# Dieses Skript veröffentlicht auf origin eine in einen einzigen
# Commit gesquashte Version des
# aktuellen Branches. Dieser veröffentlichte Branch kann dann
# zum PR gestellt werden.
# Der aktuelle Branch sollte bereits auf master rebased sein!
ORIGINAL_BRANCH_NAME=$(git symbolic-ref --short HEAD)
BRANCH_NAME="$ORIGINAL_BRANCH_NAME-squashed"
TMP_FILE=/tmp/squash-message

MASTER_HEAD_HASH=$(git rev-parse master)
git fetch origin master
FETCH_HEAD_HASH=$(git rev-parse FETCH_HEAD)
if [[ $MASTER_HEAD_HASH != $FETCH_HEAD_HASH ]]
then 
  echo "Erst Master pullen, dann $ORIGINAL_BRANCH_NAME auf den Stand von master bringen (durch rebase/merge)"
  exit 1
fi

git checkout -b $BRANCH_NAME || exit 1
echo -e "delivered $ORIGINAL_BRANCH_NAME\n\n" > $TMP_FILE
git log --oneline master..HEAD >> $TMP_FILE
git reset --soft master
git commit -aF $TMP_FILE
rm $TMP_FILE
git push --set-upstream -f origin $BRANCH_NAME
git checkout $ORIGINAL_BRANCH_NAME && git branch -D $BRANCH_NAME

